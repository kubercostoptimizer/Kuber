{"version":3,"sources":["../../src/configuration.js"],"names":["constants","jaegerSchema","id","type","properties","serviceName","disable","sampler","param","hostPort","host","port","refreshIntervalMs","required","additionalProperties","reporter","logSpans","agentHost","agentPort","collectorEndpoint","username","password","flushIntervalMs","throttler","Configuration","config","options","Error","SAMPLER_TYPE_PROBABILISTIC","ProbabilisticSampler","SAMPLER_TYPE_RATE_LIMITING","RateLimitingSampler","SAMPLER_TYPE_CONST","ConstSampler","SAMPLER_TYPE_REMOTE","RemoteSampler","refreshInterval","metrics","logger","reporterConfig","reporters","isHTTPSender","senderConfig","push","LoggingReporter","sender","HTTPSender","UDPSender","remoteReporter","RemoteReporter","length","CompositeReporter","throttlerOptions","Utils","clone","RemoteThrottler","Metrics","opentracing","Tracer","_getSampler","_getReporter","_getThrottler","info","name","contextKey","baggagePrefix","tags","debugThrottler"],"mappings":"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","file":"configuration.js","sourcesContent":["// Copyright (c) 2016 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n// in compliance with the License. You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software distributed under the License\n// is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n// or implied. See the License for the specific language governing permissions and limitations under\n// the License.\n\nimport ConstSampler from './samplers/const_sampler';\nimport ProbabilisticSampler from './samplers/probabilistic_sampler';\nimport RateLimitingSampler from './samplers/ratelimiting_sampler';\nimport RemoteReporter from './reporters/remote_reporter';\nimport CompositeReporter from './reporters/composite_reporter';\nimport LoggingReporter from './reporters/logging_reporter';\nimport RemoteSampler from './samplers/remote_sampler';\nimport Metrics from './metrics/metrics';\nimport Tracer from './tracer';\nimport UDPSender from './reporters/udp_sender';\nimport HTTPSender from './reporters/http_sender';\nimport opentracing from 'opentracing';\nimport * as constants from './constants.js';\nimport RemoteThrottler from './throttler/remote_throttler';\nimport Utils from './util.js';\n\nlet jaegerSchema = {\n  id: '/jaeger',\n  type: 'object',\n  properties: {\n    serviceName: { type: 'string' },\n    disable: { type: 'boolean' },\n    sampler: {\n      properties: {\n        type: { type: 'string' },\n        param: { type: 'number' },\n        hostPort: { type: 'string' },\n        host: { type: 'string' },\n        port: { type: 'number' },\n        refreshIntervalMs: { type: 'number' },\n      },\n      required: ['type', 'param'],\n      additionalProperties: false,\n    },\n    reporter: {\n      properties: {\n        logSpans: { type: 'boolean' },\n        agentHost: { type: 'string' },\n        agentPort: { type: 'number' },\n        collectorEndpoint: { type: 'string' },\n        username: { type: 'string' },\n        password: { type: 'string' },\n        flushIntervalMs: { type: 'number' },\n      },\n      additionalProperties: false,\n    },\n    throttler: {\n      properties: {\n        host: { type: 'string' },\n        port: { type: 'number' },\n        refreshIntervalMs: { type: 'number' },\n      },\n      additionalProperties: false,\n    },\n  },\n};\n\nexport default class Configuration {\n  static _getSampler(config, options) {\n    let type = config.sampler.type;\n    let param = config.sampler.param;\n    let hostPort = config.sampler.hostPort;\n    let host = config.sampler.host;\n    let port = config.sampler.port;\n    let refreshIntervalMs = config.sampler.refreshIntervalMs;\n\n    if (typeof param !== 'number') {\n      throw new Error(`Expecting sampler.param to be a number. Received ${param}`);\n    }\n\n    let sampler;\n    if (type === constants.SAMPLER_TYPE_PROBABILISTIC) {\n      sampler = new ProbabilisticSampler(param);\n    }\n\n    if (type === constants.SAMPLER_TYPE_RATE_LIMITING) {\n      sampler = new RateLimitingSampler(param);\n    }\n\n    if (type === constants.SAMPLER_TYPE_CONST) {\n      sampler = new ConstSampler(param === 1);\n    }\n\n    if (type === constants.SAMPLER_TYPE_REMOTE) {\n      sampler = new RemoteSampler(config.serviceName, {\n        sampler: new ProbabilisticSampler(param),\n        hostPort: hostPort,\n        host: host,\n        port: port,\n        refreshInterval: refreshIntervalMs,\n        metrics: options.metrics,\n        logger: options.logger,\n      });\n    }\n\n    return sampler;\n  }\n\n  static _getReporter(config, options) {\n    let reporterConfig = {};\n    let reporters = [];\n    let isHTTPSender = false;\n    let senderConfig = {\n      logger: options.logger,\n    };\n    if (config.reporter) {\n      if (config.reporter.logSpans) {\n        reporters.push(new LoggingReporter(options.logger));\n      }\n\n      if (config.reporter.flushIntervalMs) {\n        reporterConfig['bufferFlushInterval'] = config.reporter.flushIntervalMs;\n      }\n\n      if (config.reporter.collectorEndpoint) {\n        isHTTPSender = true;\n\n        senderConfig['endpoint'] = config.reporter.collectorEndpoint;\n\n        if (config.reporter.username) {\n          senderConfig['username'] = config.reporter.username;\n        }\n        if (config.reporter.password) {\n          senderConfig['password'] = config.reporter.password;\n        }\n      }\n      if (config.reporter.agentHost) {\n        senderConfig['host'] = config.reporter.agentHost;\n      }\n\n      if (config.reporter.agentPort) {\n        senderConfig['port'] = config.reporter.agentPort;\n      }\n    }\n    reporterConfig['metrics'] = options.metrics;\n    reporterConfig['logger'] = options.logger;\n    let sender = isHTTPSender ? new HTTPSender(senderConfig) : new UDPSender(senderConfig);\n    let remoteReporter = new RemoteReporter(sender, reporterConfig);\n    if (reporters.length == 0) {\n      return remoteReporter;\n    }\n    reporters.push(remoteReporter);\n    return new CompositeReporter(reporters);\n  }\n\n  static _getThrottler(config, options) {\n    const throttlerOptions = Utils.clone(config.throttler);\n    if (options.logger) {\n      throttlerOptions.logger = options.logger;\n    }\n    if (options.metrics) {\n      throttlerOptions.metrics = options.metrics;\n    }\n    return new RemoteThrottler(config.serviceName, throttlerOptions);\n  }\n\n  /**\n   * Initialize and return a new instance of Jaeger Tracer.\n   *\n   * The config dictionary is not validated for adherence to the schema above.\n   * Such validation can be performed like this:\n   *\n   *     import {Validator} from 'jsonschema';\n   *\n   *     let v = new Validator();\n   *     v.validate(config, jaegerSchema, {\n   *       throwError: true\n   *     });\n   *\n   * @param {Object} config - configuration matching the jaegerSchema definition.\n   * @param {Object} options - options\n   * @param {Object} [options.reporter] - if provided, this reporter will be used.\n   *        Otherwise a new reporter will be created according to the description\n   *        in the config.\n   * @param {Object} [options.throttler] - if provided, this throttler will be used.\n   *        Otherwise a new throttler will be created according to the description\n   *        in the config.\n   * @param {Object} [options.metrics] - a metrics factory (see ./_flow/metrics.js)\n   * @param {Object} [options.logger] - a logger (see ./_flow/logger.js)\n   * @param {Object} [options.tags] - set of key-value pairs which will be set\n   *        as process-level tags on the Tracer itself.\n   */\n  static initTracer(config, options = {}) {\n    let reporter;\n    let sampler;\n    let throttler;\n    if (options.metrics) {\n      options.metrics = new Metrics(options.metrics);\n    }\n    if (config.disable) {\n      return new opentracing.Tracer();\n    }\n    if (!config.serviceName) {\n      throw new Error(`config.serviceName must be provided`);\n    }\n    if (config.sampler) {\n      sampler = Configuration._getSampler(config, options);\n    } else {\n      sampler = new RemoteSampler(config.serviceName, options);\n    }\n    if (!options.reporter) {\n      reporter = Configuration._getReporter(config, options);\n    } else {\n      reporter = options.reporter;\n    }\n    if (!options.throttler) {\n      if (config.throttler) {\n        throttler = Configuration._getThrottler(config, options);\n      }\n    } else {\n      throttler = options.throttler;\n    }\n\n    if (options.logger) {\n      options.logger.info(`Initializing Jaeger Tracer with ${reporter.name()} and ${sampler.name()}`);\n    }\n\n    return new Tracer(config.serviceName, reporter, sampler, {\n      contextKey: options.contextKey,\n      baggagePrefix: options.baggagePrefix,\n      metrics: options.metrics,\n      logger: options.logger,\n      tags: options.tags,\n      debugThrottler: throttler,\n    });\n  }\n}\n"]}